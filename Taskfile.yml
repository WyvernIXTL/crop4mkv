version: '3'

tasks:
  generate-licenses:
    cmds:
      - bunx generate-license-file --input package.json --output ./embed/THIRD-PARTY-LICENSES.txt --overwrite --omit-versions --ci

  vp:
    cmds:
      - npm version {{.VERSION}} --sign-git-tag
      - git push
      - git push --tags origin
      - bun publish
    requires:
      vars:
        - VERSION

  compile:
    env:
      PACKAGE: |
        New-Item -Path ./packaged/ -ItemType Directory -ErrorAction Ignore
        New-Item -Path ./packaged/crop4mkv -ItemType Directory
        bun build --compile --minify --sourcemap ./src/index.ts --outfile ./packaged/crop4mkv/crop4mkv
        Copy-Item ./LICENSE ./packaged/crop4mkv/
        Copy-Item ./embed/RUNTIME-LICENSING.md ./packaged/crop4mkv/
        Copy-Item ./embed/THIRD-PARTY-LICENSES.txt ./packaged/crop4mkv/
        Copy-Item ./README.md ./packaged/crop4mkv/
    cmds:
      - cmd: pwsh -c "$PACKAGE"
        platforms: [windows]
      - cmd: pwsh -c "Invoke-Expression \$env:PACKAGE"
        platforms: [linux, darwin]
      - cmd: 7z a ./packaged/crop4mkv.7z ./packaged/crop4mkv/ 
        platforms: [windows]
      - cmd: tar -cJf ./packaged/crop4mkv.tar.xz ./packaged/crop4mkv
        platforms: [linux, darwin]
      - cmd: pwsh -c "Remove-Item -Recurse ./packaged/crop4mkv"

  clean:
    cmds:
      - pwsh -c "rm -Recurse packaged"
